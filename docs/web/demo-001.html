import React, { useState, useCallback, useRef, useEffect } from 'react';
import { Send, Undo, Redo, Home, ChevronLeft, Mic } from 'lucide-react';

// Type definitions
interface Moment {
  moment_id: string;
  timestamp: number;
  focus: Focus;
  canvas_frame: CanvasFrame;
  action_set: Action[];
  summary_line: string;
  risk_state: 'SAFE' | 'CONFIRM' | 'DANGEROUS';
  audit_hint: string;
  parent_moment_id?: string;
}

interface Focus {
  type: 'root' | 'task' | 'entity' | 'confirmation';
  entity_id?: string;
  task_name?: string;
  breadcrumb: string[];
}

interface CanvasFrame {
  renderer: string;
  data: any;
}

interface Action {
  label: string;
  action_id: string;
  args?: Record<string, any>;
  tier: 'SAFE' | 'CONFIRM' | 'DANGEROUS';
  speech_alias?: string;
  icon?: string;
  variant?: 'primary' | 'secondary' | 'danger' | 'neutral';
}

// Mock orchestrator
class MockOrchestrator {
  private history: Moment[] = [];
  private currentIndex: number = -1;
  private todos: Array<{id: string, text: string, done: boolean}> = [
    { id: '1', text: 'Learn OnePromptOS', done: false },
    { id: '2', text: 'Build a capability', done: false }
  ];

  constructor() {
    this.createMoment(this.getRootMoment());
  }

  private createMoment(moment: Moment) {
    this.history = this.history.slice(0, this.currentIndex + 1);
    this.history.push(moment);
    this.currentIndex++;
  }

  private getRootMoment(): Moment {
    return {
      moment_id: `moment_${Date.now()}`,
      timestamp: Date.now(),
      focus: {
        type: 'root',
        breadcrumb: ['Home']
      },
      canvas_frame: {
        renderer: 'welcome',
        data: {
          title: 'Welcome to OnePromptOS',
          subtitle: 'No forms. No pages. Only Prompt + Pixels + Actions.',
          features: [
            'Type a command in the prompt bar',
            'Try: "show todos", "add task", or "help"',
            'Click action chips below',
            'Use voice commands (say "add task")'
          ]
        }
      },
      action_set: [
        {
          label: 'Show Todos',
          action_id: 'show_todos',
          tier: 'SAFE',
          icon: '‚úì',
          variant: 'primary'
        },
        {
          label: 'Add Task',
          action_id: 'add_task',
          tier: 'SAFE',
          icon: '+',
          variant: 'secondary'
        },
        {
          label: 'Help',
          action_id: 'help',
          tier: 'SAFE',
          icon: '?',
          variant: 'neutral'
        }
      ],
      summary_line: 'Welcome to OnePromptOS',
      risk_state: 'SAFE',
      audit_hint: 'Initial state'
    };
  }

  async handlePrompt(input: string): Promise<{ next_moment?: Moment }> {
    const lower = input.toLowerCase();
    
    if (lower.includes('todo') || lower.includes('task')) {
      return this.handleAction('show_todos', {});
    } else if (lower.includes('add')) {
      return this.handleAction('add_task', {});
    } else if (lower.includes('help')) {
      return this.handleAction('help', {});
    } else if (lower.includes('clear') || lower.includes('delete all')) {
      return this.handleAction('clear_todos', {});
    } else {
      const moment: Moment = {
        moment_id: `moment_${Date.now()}`,
        timestamp: Date.now(),
        focus: {
          type: 'root',
          breadcrumb: ['Home']
        },
        canvas_frame: {
          renderer: 'text',
          data: {
            message: `I heard: "${input}"`,
            suggestion: 'Try: "show todos", "add task", or "help"'
          }
        },
        action_set: [
          {
            label: 'Show Todos',
            action_id: 'show_todos',
            tier: 'SAFE',
            variant: 'primary'
          },
          {
            label: 'Back',
            action_id: 'back',
            tier: 'SAFE',
            variant: 'neutral'
          }
        ],
        summary_line: 'Processing input',
        risk_state: 'SAFE',
        audit_hint: `User said: ${input}`
      };
      
      this.createMoment(moment);
      return { next_moment: moment };
    }
  }

  async handleAction(actionId: string, args?: any): Promise<{ next_moment?: Moment }> {
    let moment: Moment;

    switch (actionId) {
      case 'show_todos':
        moment = {
          moment_id: `moment_${Date.now()}`,
          timestamp: Date.now(),
          focus: {
            type: 'task',
            task_name: 'todos',
            breadcrumb: ['Home', 'Todos']
          },
          canvas_frame: {
            renderer: 'todo_list',
            data: {
              todos: this.todos,
              total: this.todos.length,
              completed: this.todos.filter(t => t.done).length
            }
          },
          action_set: [
            {
              label: 'Add Task',
              action_id: 'add_task',
              tier: 'SAFE',
              icon: '+',
              variant: 'primary'
            },
            {
              label: 'Clear All',
              action_id: 'clear_todos',
              tier: 'DANGEROUS',
              icon: 'üóë',
              variant: 'danger'
            },
            {
              label: 'Back',
              action_id: 'back',
              tier: 'SAFE',
              variant: 'neutral'
            }
          ],
          summary_line: `${this.todos.length} tasks`,
          risk_state: 'SAFE',
          audit_hint: 'Viewing todo list'
        };
        break;

      case 'add_task':
        moment = {
          moment_id: `moment_${Date.now()}`,
          timestamp: Date.now(),
          focus: {
            type: 'task',
            task_name: 'add_task',
            breadcrumb: ['Home', 'Todos', 'Add Task']
          },
          canvas_frame: {
            renderer: 'prompt_for_input',
            data: {
              question: 'What task would you like to add?',
              hint: 'Type your task in the prompt bar above'
            }
          },
          action_set: [
            {
              label: 'Cancel',
              action_id: 'show_todos',
              tier: 'SAFE',
              variant: 'neutral'
            }
          ],
          summary_line: 'Adding new task',
          risk_state: 'SAFE',
          audit_hint: 'Awaiting task input'
        };
        break;

      case 'submit_task':
        const newTask = {
          id: Date.now().toString(),
          text: args.text,
          done: false
        };
        this.todos.push(newTask);
        
        moment = {
          moment_id: `moment_${Date.now()}`,
          timestamp: Date.now(),
          focus: {
            type: 'task',
            task_name: 'todos',
            breadcrumb: ['Home', 'Todos']
          },
          canvas_frame: {
            renderer: 'todo_list',
            data: {
              todos: this.todos,
              total: this.todos.length,
              completed: this.todos.filter(t => t.done).length,
              message: `Added: "${args.text}"`
            }
          },
          action_set: [
            {
              label: 'Add Another',
              action_id: 'add_task',
              tier: 'SAFE',
              icon: '+',
              variant: 'primary'
            },
            {
              label: 'Back',
              action_id: 'back',
              tier: 'SAFE',
              variant: 'neutral'
            }
          ],
          summary_line: `${this.todos.length} tasks`,
          risk_state: 'SAFE',
          audit_hint: `Added task: ${args.text}`
        };
        break;

      case 'toggle_todo':
        const todo = this.todos.find(t => t.id === args.id);
        if (todo) {
          todo.done = !todo.done;
        }
        
        moment = {
          moment_id: `moment_${Date.now()}`,
          timestamp: Date.now(),
          focus: {
            type: 'task',
            task_name: 'todos',
            breadcrumb: ['Home', 'Todos']
          },
          canvas_frame: {
            renderer: 'todo_list',
            data: {
              todos: this.todos,
              total: this.todos.length,
              completed: this.todos.filter(t => t.done).length
            }
          },
          action_set: [
            {
              label: 'Add Task',
              action_id: 'add_task',
              tier: 'SAFE',
              icon: '+',
              variant: 'primary'
            },
            {
              label: 'Clear All',
              action_id: 'clear_todos',
              tier: 'DANGEROUS',
              icon: 'üóë',
              variant: 'danger'
            },
            {
              label: 'Back',
              action_id: 'back',
              tier: 'SAFE',
              variant: 'neutral'
            }
          ],
          summary_line: `${this.todos.length} tasks`,
          risk_state: 'SAFE',
          audit_hint: `Toggled task: ${todo?.text}`
        };
        break;

      case 'clear_todos':
        moment = {
          moment_id: `moment_${Date.now()}`,
          timestamp: Date.now(),
          focus: {
            type: 'confirmation',
            breadcrumb: ['Home', 'Todos', 'Confirm']
          },
          canvas_frame: {
            renderer: 'confirmation',
            data: {
              title: '‚ö†Ô∏è Dangerous Operation',
              message: `Delete all ${this.todos.length} tasks?`,
              warning: 'This action cannot be undone.'
            }
          },
          action_set: [
            {
              label: 'Yes, Delete All',
              action_id: 'confirm_clear_todos',
              tier: 'DANGEROUS',
              variant: 'danger'
            },
            {
              label: 'Cancel',
              action_id: 'show_todos',
              tier: 'SAFE',
              variant: 'neutral'
            }
          ],
          summary_line: 'Confirm deletion',
          risk_state: 'DANGEROUS',
          audit_hint: 'Awaiting confirmation to delete all tasks'
        };
        break;

      case 'confirm_clear_todos':
        this.todos = [];
        
        moment = {
          moment_id: `moment_${Date.now()}`,
          timestamp: Date.now(),
          focus: {
            type: 'task',
            task_name: 'todos',
            breadcrumb: ['Home', 'Todos']
          },
          canvas_frame: {
            renderer: 'todo_list',
            data: {
              todos: this.todos,
              total: 0,
              completed: 0,
              message: 'All tasks deleted'
            }
          },
          action_set: [
            {
              label: 'Add Task',
              action_id: 'add_task',
              tier: 'SAFE',
              icon: '+',
              variant: 'primary'
            },
            {
              label: 'Back',
              action_id: 'back',
              tier: 'SAFE',
              variant: 'neutral'
            }
          ],
          summary_line: 'No tasks',
          risk_state: 'SAFE',
          audit_hint: 'Deleted all tasks'
        };
        break;

      case 'help':
        moment = {
          moment_id: `moment_${Date.now()}`,
          timestamp: Date.now(),
          focus: {
            type: 'root',
            breadcrumb: ['Home', 'Help']
          },
          canvas_frame: {
            renderer: 'help',
            data: {
              commands: [
                { cmd: 'show todos', desc: 'View your task list' },
                { cmd: 'add task', desc: 'Create a new task' },
                { cmd: 'clear all', desc: 'Delete all tasks' },
                { cmd: 'help', desc: 'Show this help' }
              ],
              principles: [
                'No forms - only prompts',
                'No pages - only moments',
                'Actions are chips - not buttons'
              ]
            }
          },
          action_set: [
            {
              label: 'Show Todos',
              action_id: 'show_todos',
              tier: 'SAFE',
              variant: 'primary'
            },
            {
              label: 'Back',
              action_id: 'back',
              tier: 'SAFE',
              variant: 'neutral'
            }
          ],
          summary_line: 'Help',
          risk_state: 'SAFE',
          audit_hint: 'Viewing help'
        };
        break;

      case 'back':
        return { next_moment: this.back() || undefined };

      default:
        moment = this.getRootMoment();
    }

    this.createMoment(moment);
    return { next_moment: moment };
  }

  getCurrent(): Moment {
    return this.history[this.currentIndex];
  }

  back(): Moment | null {
    if (this.currentIndex > 0) {
      this.currentIndex--;
      return this.history[this.currentIndex];
    }
    return null;
  }

  canGoBack(): boolean {
    return this.currentIndex > 0;
  }

  undo(): Moment | null {
    return this.back();
  }

  redo(): Moment | null {
    if (this.currentIndex < this.history.length - 1) {
      this.currentIndex++;
      return this.history[this.currentIndex];
    }
    return null;
  }

  canGoForward(): boolean {
    return this.currentIndex < this.history.length - 1;
  }

  home(): Moment {
    const rootMoment = this.getRootMoment();
    this.createMoment(rootMoment);
    return rootMoment;
  }
}

// Canvas renderers
const CanvasRenderer: React.FC<{ moment: Moment; onAction: (id: string, args?: any) => void }> = ({ moment, onAction }) => {
  const { renderer, data } = moment.canvas_frame;

  switch (renderer) {
    case 'welcome':
      return (
        <div className="p-8 text-center">
          <h1 className="text-4xl font-bold mb-4 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
            {data.title}
          </h1>
          <p className="text-xl text-gray-600 mb-8">{data.subtitle}</p>
          <div className="max-w-md mx-auto text-left space-y-3">
            {data.features.map((feature: string, i: number) => (
              <div key={i} className="flex items-start gap-3 text-gray-700">
                <span className="text-blue-500 font-bold">{i + 1}.</span>
                <span>{feature}</span>
              </div>
            ))}
          </div>
        </div>
      );

    case 'todo_list':
      return (
        <div className="p-6">
          <div className="flex items-center justify-between mb-6">
            <h2 className="text-2xl font-bold">Todo List</h2>
            <div className="text-sm text-gray-600">
              {data.completed}/{data.total} completed
            </div>
          </div>
          {data.message && (
            <div className="mb-4 p-3 bg-green-50 text-green-800 rounded-lg">
              ‚úì {data.message}
            </div>
          )}
          {data.todos.length === 0 ? (
            <div className="text-center py-12 text-gray-400">
              <div className="text-6xl mb-4">üìù</div>
              <p>No tasks yet. Add one to get started!</p>
            </div>
          ) : (
            <div className="space-y-2">
              {data.todos.map((todo: any) => (
                <div
                  key={todo.id}
                  className="flex items-center gap-3 p-4 bg-white rounded-lg border border-gray-200 hover:border-blue-300 cursor-pointer transition-colors"
                  onClick={() => onAction('toggle_todo', { id: todo.id })}
                >
                  <div className={`w-5 h-5 rounded border-2 flex items-center justify-center ${
                    todo.done ? 'bg-blue-500 border-blue-500' : 'border-gray-300'
                  }`}>
                    {todo.done && <span className="text-white text-xs">‚úì</span>}
                  </div>
                  <span className={todo.done ? 'line-through text-gray-400' : 'text-gray-800'}>
                    {todo.text}
                  </span>
                </div>
              ))}
            </div>
          )}
        </div>
      );

    case 'prompt_for_input':
      return (
        <div className="p-8 text-center">
          <div className="text-6xl mb-6">üí≠</div>
          <h2 className="text-2xl font-bold mb-4">{data.question}</h2>
          <p className="text-gray-600">{data.hint}</p>
        </div>
      );

    case 'confirmation':
      return (
        <div className="p-8 text-center">
          <div className="text-6xl mb-6">{data.title.includes('‚ö†Ô∏è') ? '‚ö†Ô∏è' : '‚ùì'}</div>
          <h2 className="text-2xl font-bold mb-4">{data.title}</h2>
          <p className="text-lg text-gray-700 mb-2">{data.message}</p>
          {data.warning && (
            <p className="text-red-600 font-semibold">{data.warning}</p>
          )}
        </div>
      );

    case 'help':
      return (
        <div className="p-6">
          <h2 className="text-2xl font-bold mb-6">Help</h2>
          
          <div className="mb-6">
            <h3 className="text-lg font-semibold mb-3">Available Commands</h3>
            <div className="space-y-2">
              {data.commands.map((cmd: any, i: number) => (
                <div key={i} className="flex gap-4 p-3 bg-gray-50 rounded">
                  <code className="text-blue-600 font-mono">{cmd.cmd}</code>
                  <span className="text-gray-600">- {cmd.desc}</span>
                </div>
              ))}
            </div>
          </div>

          <div>
            <h3 className="text-lg font-semibold mb-3">Core Principles</h3>
            <div className="space-y-2">
              {data.principles.map((principle: string, i: number) => (
                <div key={i} className="flex items-start gap-3 text-gray-700">
                  <span className="text-purple-500">‚Ä¢</span>
                  <span>{principle}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );

    case 'text':
      return (
        <div className="p-8 text-center">
          <p className="text-xl mb-4">{data.message}</p>
          {data.suggestion && (
            <p className="text-gray-600">{data.suggestion}</p>
          )}
        </div>
      );

    default:
      return <div className="p-8 text-center text-gray-500">Unknown renderer</div>;
  }
};

// Main App Component
const OnePromptOS: React.FC = () => {
  const [orchestrator] = useState(() => new MockOrchestrator());
  const [currentMoment, setCurrentMoment] = useState<Moment>(orchestrator.getCurrent());
  const [input, setInput] = useState('');
  const [isProcessing, setIsProcessing] = useState(false);
  const inputRef = useRef<HTMLInputElement>(null);

  const handleSubmit = async () => {
    if (!input.trim() || isProcessing) return;

    setIsProcessing(true);
    const currentFocus = currentMoment.focus;

    // Handle special case: adding task
    if (currentFocus.task_name === 'add_task') {
      const result = await orchestrator.handleAction('submit_task', { text: input });
      if (result.next_moment) {
        setCurrentMoment(result.next_moment);
      }
      setInput('');
    } else {
      const result = await orchestrator.handlePrompt(input);
      if (result.next_moment) {
        setCurrentMoment(result.next_moment);
      }
      setInput('');
    }
    
    setIsProcessing(false);
    inputRef.current?.focus();
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSubmit();
    }
  };

  const handleAction = async (actionId: string, args?: any) => {
    setIsProcessing(true);
    const result = await orchestrator.handleAction(actionId, args);
    if (result.next_moment) {
      setCurrentMoment(result.next_moment);
    }
    setIsProcessing(false);
  };

  const handleBack = () => {
    const prev = orchestrator.back();
    if (prev) setCurrentMoment(prev);
  };

  const handleUndo = () => {
    const prev = orchestrator.undo();
    if (prev) setCurrentMoment(prev);
  };

  const handleRedo = () => {
    const next = orchestrator.redo();
    if (next) setCurrentMoment(next);
  };

  const handleHome = () => {
    const home = orchestrator.home();
    setCurrentMoment(home);
  };

  const getRiskColor = (risk: string) => {
    switch (risk) {
      case 'DANGEROUS': return 'bg-red-50 border-red-200';
      case 'CONFIRM': return 'bg-yellow-50 border-yellow-200';
      default: return 'bg-gray-50 border-gray-200';
    }
  };

  const getActionVariantClass = (variant?: string) => {
    switch (variant) {
      case 'primary': return 'bg-blue-500 text-white hover:bg-blue-600';
      case 'danger': return 'bg-red-500 text-white hover:bg-red-600';
      case 'secondary': return 'bg-purple-500 text-white hover:bg-purple-600';
      default: return 'bg-gray-200 text-gray-800 hover:bg-gray-300';
    }
  };

  return (
    <div className="h-screen flex flex-col bg-gradient-to-br from-gray-50 to-blue-50">
      {/* Prompt Bar */}
      <div className="bg-white border-b border-gray-200 shadow-sm">
        <div className="max-w-6xl mx-auto p-4">
          <div className="flex items-center gap-2 mb-2">
            <button
              onClick={handleBack}
              disabled={!orchestrator.canGoBack()}
              className="p-2 rounded hover:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed"
              title="Back"
            >
              <ChevronLeft size={20} />
            </button>
            <button
              onClick={handleHome}
              className="p-2 rounded hover:bg-gray-100"
              title="Home"
            >
              <Home size={20} />
            </button>
            <button
              onClick={handleUndo}
              disabled={!orchestrator.canGoBack()}
              className="p-2 rounded hover:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed"
              title="Undo"
            >
              <Undo size={20} />
            </button>
            <button
              onClick={handleRedo}
              disabled={!orchestrator.canGoForward()}
              className="p-2 rounded hover:bg-gray-100 disabled:opacity-30 disabled:cursor-not-allowed"
              title="Redo"
            >
              <Redo size={20} />
            </button>
            <div className="flex-1" />
            <div className="text-sm text-gray-500">
              {currentMoment.focus.breadcrumb.join(' ‚Ä∫ ')}
            </div>
          </div>
          
          <div className="flex gap-2">
            <input
              ref={inputRef}
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyDown={handleKeyDown}
              placeholder="Type a command or question..."
              className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              disabled={isProcessing}
            />
            <button
              onClick={() => alert('Voice input demo - speak your command')}
              className="p-3 rounded-lg bg-gray-100 hover:bg-gray-200"
              title="Voice input"
            >
              <Mic size={20} />
            </button>
            <button
              onClick={handleSubmit}
              disabled={!input.trim() || isProcessing}
              className="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
            >
              <Send size={20} />
              Send
            </button>
          </div>
        </div>
      </div>

      {/* Canvas */}
      <div className={`flex-1 overflow-auto border-4 ${getRiskColor(currentMoment.risk_state)}`}>
        <div className="max-w-4xl mx-auto">
          <CanvasRenderer moment={currentMoment} onAction={handleAction} />
        </div>
      </div>

      {/* Action Strip */}
      <div className="bg-white border-t border-gray-200 shadow-lg">
        <div className="max-w-6xl mx-auto p-4">
          <div className="flex items-center justify-between mb-2">
            <div className="text-sm font-medium text-gray-600">
              {currentMoment.summary_line}
            </div>
            <div className="text-xs text-gray-400">
              {currentMoment.audit_hint}
            </div>
          </div>
          <div className="flex gap-2 flex-wrap">
            {currentMoment.action_set.map((action, index) => (
              <button
                key={action.action_id}
                onClick={() => handleAction(action.action_id, action.args)}
                disabled={isProcessing}
                className={`px-4 py-2 rounded-lg font-medium transition-colors disabled:opacity-50 ${getActionVariantClass(action.variant)}`}
              >
                {action.icon && <span className="mr-2">{action.icon}</span>}
                {action.label}
                {action.speech_alias && (
                  <span className="ml-2 text-xs opacity-70">({index + 1})</span>
                )}
              </button>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
};

export default OnePromptOS;
